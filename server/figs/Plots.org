* Getting Diospyros Numbers

Run Diospyros experiments on the server. We're using =master= instead of the ASPLOS tag because we want to use the latest version of Rosette.

#+begin_src async-shell :dir (ec2/tramp "exp" "diospyros") :results none :name dios
# git checkout master
# git pull -r

make
cargo build --release --manifest-path /home/ubuntu/diospyros/src/dios-egraphs/Cargo.toml
tmux new -d -s diospyros
tmux send-keys -t diospyros "python3 evaluation/eval_benchmarks.py --timeout 180 --skiprun -o results-t180" ENTER
# python3 evaluation/eval_benchmarks.py --timeout 180 --skiprun -o results-t180
#+end_src

Copy the results back here, so that we can analyze them.

#+begin_src async-shell :dir (sgt/dir "server") :var IP=(ec2/get-ip "exp") :results none :name dios
rsync -avh ubuntu@$IP:~/diospyros/results-t180/ completed/diospyros/1
#+end_src

Some changes to diospyros are needed before we can run estimation. We need to go into =evaluation/shared.mk= and edit the paths so that they point to the right places.

I don't have the expert matrix kernel, so I comment out that from the =mat-mul/harness.c=

The nature files seem to be in a different location than what Dios expects. So I symlinked the =.c= files into where they are supposed to be. Here's the command (from the fusion_g3 library):

#+begin_src async-shell :name dios :dir ~/Research/xtensa/fusiong3_library
# mat-mul nature objects
ln -s matrix/matmmltf_pdx4.c matmmltf_pdx4.c

# 2d-conv nature objects
ln -s filter/2d/conv2df_pdx4.c conv2df_pdx4.c

# qr-decomp nature objects
ln -s matinv/qrf/matinvqrf_pdx4.c matinvqrf_pdx4.c
ln -s matinv/qrf/matinvqrrotf_pdx4.c matinvqrrotf_pdx4.c
ln -s matrix/transpmf_pdx4.c transpmf_pdx4.c
ln -s matrix/transpm32cache_pdx4.c transpm32cache_pdx4.c
#+end_src

Finally, the command to actually perform cycle estimates on all the benchmarks.

#+header: :dir (sgt/dir ".." "cucapra-diospyros")
#+begin_src async-shell :name dios :results none
python3 evaluation/eval_benchmarks.py \
        --skipsynth \
        -o ~/Research/comp-gen/server/completed/diospyros/0
#+end_src

** Syncing diospyros-results between machines

#+begin_src async-shell :name dios :dir (sgt/dir "server") :results none
rsync -avh samthomas@sgt.csres.utexas.edu:~/Research/comp-gen/server/diospyros-results-log/ \
      diospyros-results-log
#+end_src

* Start jobs and sync data

Create jobs.

#+begin_src async-shell :dir (sgt/dir "server") :results none :name sync
./jobs.py
ls jobs
#+end_src

Sync jobs.

#+begin_src async-shell :dir (sgt/dir "server") :results none :name sync
./sync.py both
#+end_src

* Data processing
:PROPERTIES:
:header-args:async-shell: :dir (sgt/dir "server") :results none
:END:

Testing my cycle-estimation script. At the moment, this will assume a completely compile =kernel.c= file. At some point I'll want to make this work for an arbitrary egg input.

(header args for doing cycle estimation from non-thelio computers)

#+header: :dir (sgt/dir "server")
#+begin_src async-shell :name estimation
# ./estimate.py many latest --key noeqsat --override-name noeqsat --force
# ./estimate.py many Mar29-1443 --key performance --force
./estimate.py many latest --key performance
#+end_src

#+begin_src async-shell :name sync
rsync -avh samthomas@sgt.csres.utexas.edu:~/Research/comp-gen/server/completed/ completed
# rsync -avh \
#       --exclude "*compile-log.txt" \
#       completed/ samthomas@sgt.csres.utexas.edu:~/Research/comp-gen/server/completed
#+end_src

Process all the log files and generate data csvs.

#+begin_src async-shell :name processed
./process.py all completed/
#+end_src

Run query to generate aggregated data files

#+begin_src async-shell :name query
python3.11 query.py
#+end_src

Rewriting my =query.py= script.

#+begin_src async-shell :name query
./query2.py update est_cycles -t latest --commit
#+end_src

* Tables

Generate the SLoC table for the evaluation section

#+begin_src async-shell :dir (sgt/dir) :results none :ansi t
# compgen library
cd comp-gen
compgen=$(tokei src -o json | jq .Total.code)
cd ..

cd dios-lang
spec=$(tokei src -o json | \
           jq ".Rust.reports[] | select(.name == \"src/synthesis.rs\") | .stats.code")
cost=$(tokei src -o json | \
           jq ".Rust.reports[] | select(.name == \"src/cost.rs\") | .stats.code")
harness=$(tokei src -o json | jq .Total.code)

echo "\\\newcommand{\\\sloccompgen}{$compgen}"
echo "\\\newcommand{\\\slocspec}{$spec}"
echo "\\\newcommand{\\\sloccost}{$cost}"
echo "\\\newcommand{\\\slocharness}{$((harness - spec - cost))}"
echo "\\\newcommand{\\\sloctotal}{$((compgen + harness))}"
#+end_src

* Pictures!!
:PROPERTIES:
:header-args:R: :session cycest :colnames yes
:END:

Import the R libraries that we will use.

#+begin_src R :results none
library(tidyverse)
library(extrafont)
library(ggpattern)
library(tikzDevice)
library(xtable)
#+end_src

** Performance graphs

*** Label Formatting Function

#+begin_src R
shrink <- function(input) {
  parts <- str_split(input, "x", simplify=T)
  if (parts[1] == parts[2]) {
    str_c(parts[1], "$^2$", collapse="")
  } else {
    input
  }
}

format <- function(input) {
  str_flatten(map(str_split(input, "_", simplify=T), shrink), collapse="\n")
}

format_vec <- function(input) {
  str_replace_all(input, "_", "\n")
}

format_vec(c("10x10_2x2", "12x12_3x3"))
#+end_src

#+RESULTS:
|     x |
|-------|
| 10x10 |
|   2x2 |
| 12x12 |
|   3x3 |

*** DONE Cycle count
CLOSED: [2023-03-29 Wed 10:03]
:LOGBOOK:
- State "DONE"       from "WAITING"    [2023-03-29 Wed 10:03]
:END:

#+header: :width 650 :height 300

#+header: :width 6.85 :height 2.85
#+begin_src R :results graphics output file :file cycles-performance.tikz
data <- full_join(
  read_csv("data/diospyros.csv"),
  read_csv("data/est_cycles.csv")
)

to_face <- function(sat) {
  map_chr(sat, function(x) {
    if (x == "yes") {
      "black"
    } else {
      "red"
    }  
  })
}

faces <- data %>%
  filter(kernel == "dios") %>%
  select(saturated) %>%
  mutate(
    bold=to_face(saturated)
  )

data <- data %>%
  ## filter(benchmark == "2d-conv" | benchmark == "mat-mul") %>%
  select(benchmark, params, kernel, cycles) %>%
  group_by(benchmark) %>%
  pivot_wider(
    names_from=kernel,
    values_from=cycles
  ) %>%
  mutate(
    benchmark=recode(benchmark,
                     "qr-decomp"="QrD",
                     "2d-conv"="2DC",
                     "mat-mul"="MM",
                     "q-prod"="QP"
                     ),
    name = str_c(
      str_replace_all(str_replace_all(params, "x", "$\\\\times$"), "_", "\n"),
      "\n",
      benchmark
    ),
    norm = naive.fixed,
    compgen = norm / compgen,
    dios = norm / dios,
    nature = norm / nature,
    naive = norm / naive,
    naive.fixed = norm / naive.fixed,
    naive.clang = norm / naive.clang,
  ) %>%
  pivot_longer(
    cols = c("naive.fixed", "naive.clang", "nature", "dios", "compgen"),
    names_to = "kernel",
    values_to = "cycles"
  ) %>%
  select(name, kernel, cycles)

data %>%
  group_by(benchmark) %>%
  ggplot(aes(
    xmin=as.numeric(factor(name, levels=unique(name))) - 0.35,
    xmax=as.numeric(factor(name, levels=unique(name))) + 0.35,
    ymin=0,
    ymax=cycles,
    fill=factor(kernel, levels=unique(kernel))
  )) +
  geom_rect(
    position="dodge",
    color="black",
  ) +
  geom_hline(yintercept=1, linetype="solid", color="black") +
  labs(y="Speed up over Naive (fixed size)", fill="Compiler") +
  scale_x_continuous(
    label=unique(data$name),
    breaks=1:length(unique(data$name))
  ) +
  scale_y_continuous(
    trans="log2"
  ) +
  scale_fill_brewer(
    palette = "Paired",
    labels=c(
      "Naive",
      "Naive (vectorized)",
      "Nature",
      "Diospyros",
      "Compgen"
    )
  ) +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_text(size=8, face="bold"),

    axis.text.x = element_text(size=5, color="black"),
    axis.text.y = element_text(size=8, color="black"),

    legend.position = "top",
    legend.background = element_blank(),
    legend.text = element_text(size=7, face="bold"),
    legend.title = element_blank(),
    legend.key.size = unit(0.75, "lines"),
    legend.box.spacing = unit(0, "lines"), 
    legend.margin = margin(0, 0, 2, 0),

    panel.spacing.x = unit(0, "lines"),

    strip.placement = "outside"
  )
#+end_src

#+RESULTS:
[[file:cycles-performance.tikz]]

#+begin_src R :session cycest
data <- full_join(full_join(
  read_csv("data/stock_cycles.csv"),
  read_csv("data/est_cycles.csv")
  %>% filter(timeout == "180")
  %>% filter(params != "18x18_2x2")
  %>% filter(params != "18x18_3x3")
  %>% filter(params != "18x18_4x4")
  %>% filter(params != "18x18_18x18")
  %>% filter(params != "20x20_20x20")
), read_csv("data/noeqsat.csv"))

data %>% filter(kernel == "nature" | kernel == "compgen") %>%
  select(kernel, benchmark, params, cycles) %>%
  pivot_wider(
    names_from=kernel,
    values_from=cycles
  ) %>%
  mutate(
    speedup=nature / compgen 
  ) %>% summarise(mean = mean(speedup, na.rm = T), n = n())
#+end_src

#+RESULTS:
|             mean |  n |
|------------------+----|
| 3.27463214032345 | 21 |

*** DONE Compilation time
CLOSED: [2023-04-16 Sun 10:04]
:LOGBOOK:
- State "DONE"       from "NEXT"       [2023-04-16 Sun 10:04]
:END:

#+header: :width 3 :height 2
#+begin_src R :results graphics file :file compile-times.tikz
data <- full_join(
  read_csv("data/diospyros.csv"),
  read_csv("data/est_cycles.csv")
)

# fix the order of params cat var
## data$params <- factor(data$params, levels=unique(data$params))

data <- data %>%
  ##  %>%
  ## filter(greedy == "True") %>%
  ## filter(benchmark == "2d-conv" | benchmark == "mat-mul") %>%
  select(benchmark, params, kernel, compile_time) %>%
  pivot_wider(
    names_from=kernel,
    values_from=compile_time
  ) %>%
  group_by(benchmark) %>%
  mutate(
    benchmark=recode(benchmark, "qr-decomp"="qr", "q-prod"="q"),
    ## name=str_replace_all(params, "_", "\n")
    ## name=if_else(str_detect(params, "x"), row_number(), params),
    name=row_number()
  ) %>%
  print(n=100) %>%
  pivot_longer(
    cols = c("dios", "compgen"),
    names_to = "kernel",
    values_to = "compile_time"
  )
data %>%
  ggplot(aes(
    x=factor(name, levels=unique(name)),
    y=compile_time,
    fill=factor(kernel, levels=unique(kernel))
  )) +
  facet_grid(
    ~benchmark,
    switch="x",
    scales = "free_x", space="free_x"
  ) +
  geom_col(
    position="dodge",
    color="black",
    width=0.5
  ) +
  geom_hline(
    yintercept=180,
  ) +
  coord_cartesian(ylim = c(0, 1000)) +
  ## scale_y_log10() +
  scale_fill_manual(
    values = c("#33a02c", "#fb9a99"),
    labels=c("Diospyros", "Compgen")
  ) +
  labs(y="Compile Time", fill="Compiler") +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_text(size=8, face="bold"),

    axis.text.x = element_text(size=5, color="black"),
    axis.text.y = element_text(size=7, color="black"),

    legend.position = "top",
    legend.background = element_blank(),
    legend.text = element_text(size=7, face="bold"),
    legend.title = element_blank(),
    legend.key.size = unit(0.75, "lines"),
    legend.box.spacing = unit(0, "lines"), 
    legend.margin = margin(0, 0, 2, 0),

    panel.spacing.x = unit(0, "lines"),

    strip.placement = "outside",
    strip.text.x = element_text(size=6, face="bold"),
    
    ## axis.title.x = element_blank(),
    ## ## legend.position = c(0.9, 0.9),
    ## legend.position = "top",
    ## legend.background = element_rect(fill = "white"),
    ## text = element_text(size=6, face="bold"),
    ## panel.spacing.x = unit(0, "lines"),
    ## strip.placement = "outside",
    ## strip.text.x = element_text(
    ##   angle=0
    ## ),
    ## strip.background.x = element_rect(
    ##   color="black", linetype="solid",
    ## ),
  )
#+end_src

#+RESULTS:
[[file:compile-times.tikz]]

*** Memory Usage

#+header: :width 13 :height 5
#+begin_src R :results graphics file :file memory-performance.svg
data <- full_join(
  read_csv("data/stock_cycles.csv"),
  read_csv("data/est_cycles.csv")
  ## comment
)

data$params <- factor(data$params, levels=unique(data$params))

data <- data %>%
  ##  %>%
  ## filter(greedy == "True") %>%
  filter(benchmark == "2d-conv" | benchmark == "mat-mul") %>%
  filter(kernel == "dios" | kernel == "compgen") %>%
  select(benchmark, params, kernel, max_ram_used) %>%
  group_by(benchmark) %>%
  pivot_wider(
    names_from=kernel,
    values_from=max_ram_used
  ) %>%
  ## mutate(
  ##   compgen = compgen / dios,
  ##   dios = dios / dios,
  ## ) %>%
  pivot_longer(
    cols = c("dios", "compgen"),
    names_to = "kernel",
    values_to = "memory"
  ) %>%
  print()

data %>%
  ggplot(aes(
    x=params,
    y=memory,
    fill=kernel
  )) +
  facet_wrap(~benchmark, strip.position = "bottom", scales = "free_x") +
  geom_bar(position="dodge", stat="identity", color="black") +
  ## ylim(0, 1.5) +
  ## scale_fill_discrete(labels=c("Compgen", "Stock Dios")) +
  labs(y="Max Memory Used (GiB)", fill="Compiler") +
  ## scale_y_log10() +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1),
    axis.title.x = element_blank(),
    legend.position = c(0.15, 0.9),
    legend.background = element_rect(fill = "white"),
    text = element_text(size=12, face="bold")
  ) +
  scale_fill_brewer(palette = "Set2")
#+end_src

#+RESULTS:
[[file:memory-performance.svg]]

*** Equality Saturation Ablation

Actually use 11 as the width
#+header: :width 9 :height 4
#+begin_src R :results graphics file :file noeqsat.svg
data <- full_join(full_join(
  read_csv("data/stock_cycles.csv"),
  read_csv("data/est_cycles.csv")
), read_csv("data/noeqsat.csv"))

data <- data %>%
  filter(benchmark == "2d-conv") %>%
  print(n=100) %>%
  select(benchmark, params, kernel, cycles) %>%
  group_by(benchmark) %>%
  pivot_wider(
    names_from=kernel,
    values_from=cycles
  ) %>%
  mutate(
    name = str_c(str_replace_all(params, "_", "\n")),
    norm = noeqsat,
    compgen = norm / compgen,
    dios = norm / dios,
    nature = norm / nature,
    noeqsat = norm / noeqsat,
    naive = norm / naive,
    naive.fixed = norm / naive.fixed,
    naive.clang = norm / naive.clang
  ) %>%
  pivot_longer(
    cols = c("dios", "compgen", "noeqsat"),
    names_to = "kernel",
    values_to = "cycles"
  ) %>%
  select(name, kernel, cycles) %>%
  print(n=60)

data %>%
  ggplot(aes(
    xmin=as.numeric(factor(name, levels=unique(name))) - 0.35,
    xmax=as.numeric(factor(name, levels=unique(name))) + 0.35,
    ymin=0,
    ymax=cycles,
    fill=factor(kernel, levels=unique(kernel))
  )) +
  geom_rect(
    position="dodge",
    color="black",
  ) +
  geom_hline(yintercept=1, linetype="solid", color="black") +
  labs(x="2d-conv", y="Speed up over No Equality Saturation", fill="Compiler") +
  scale_x_continuous(
    label=unique(data$name),
    breaks=1:length(unique(data$name))
  ) +
  scale_y_continuous(
    trans="log2",
  ) +
  scale_fill_brewer(
    palette = "Paired",
    ## labels=c(
    ##   "Diospyros",
    ##   "Compgen"
    ## )
  ) +
  theme_minimal() +
  theme(
    ## axis.title.x = element_blank(),
    ## legend.position = c(0.80, 0.77),
    legend.position = "top",
    legend.background = element_rect(fill = "white"),
    text = element_text(size=12, face="bold"),
    panel.spacing.x = unit(0, "lines")
  )
#+end_src

#+RESULTS:
[[file:noeqsat.svg]]

*** Compilation timeout graph

#+header: :width 13 :height 4
#+begin_src R :results graphics file :file compilation_timeout_ablation.svg
data <- full_join(full_join(
  read_csv("data/stock_cycles.csv") %>% mutate(across(max_ram_used, as.character)),
  read_csv("data/est_cycles.csv") %>% mutate(kernel=str_c(kernel, ".", timeout))
), read_csv("data/noeqsat.csv"))

to_face <- function(sat) {
  map_chr(sat, function(x) {
    if (x == "yes") {
      "black"
    } else {
      "red"
    }  
  })
}

faces <- data %>%
  filter(kernel == "dios") %>%
  select(saturated) %>%
  mutate(
    bold=to_face(saturated)
  ) %>%
  print(n=20)

data <- data %>%
  print(n=142) %>%
  ## filter(benchmark == "2d-conv" | benchmark == "mat-mul") %>%
  select(benchmark, params, kernel, cycles) %>%
  group_by(benchmark) %>%
  pivot_wider(
    names_from=kernel,
    values_from=cycles
  ) %>%
  mutate(
    name = str_c(str_replace_all(params, "_", "\n"), "\n", benchmark),
    norm = noeqsat,
    compgen.180 = norm / compgen.180,
    compgen.1800 = norm / compgen.1800,
    dios = norm / dios,
    nature = norm / nature,
    noeqsat = norm / noeqsat,
  ) %>%
  pivot_longer(
    cols = c("noeqsat", "dios", "compgen.180", "compgen.1800"),
    names_to = "kernel",
    values_to = "cycles"
  ) %>%
  select(name, kernel, cycles) %>%
  print(n=60)

data %>%
  ggplot(aes(
    xmin=as.numeric(factor(name, levels=unique(name))) - 0.35,
    xmax=as.numeric(factor(name, levels=unique(name))) + 0.35,
    ymin=0,
    ymax=cycles,
    fill=factor(kernel, levels=unique(kernel))
  )) +
  geom_rect(
    position="dodge",
    color="black",
    ) +
  geom_hline(yintercept=1, linetype="solid", color="black") +
  labs(y="Speed up over Naive (fixed size)", fill="Compiler") +
  scale_x_continuous(
    label=unique(data$name),
    breaks=1:length(unique(data$name))
  ) +
  scale_y_continuous(
    trans="log2"
  ) +
  scale_fill_brewer(
    palette = "Paired",
    ## labels=c(
    ##   "Naive",
    ##   "Naive (vectorized)",
    ##   "Nature",
    ##   "Diospyros",
    ##   "Compgen"
    ## )
  ) +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    ## axis.text.x = element_text(color=faces$bold),
    ## legend.position = c(0.80, 0.77),
    legend.position = "top",
    legend.background = element_rect(fill = "white"),
    text = element_text(size=12, face="bold"),
    panel.spacing.x = unit(0, "lines")
  )
#+end_src

#+RESULTS:
[[file:compilation_timeout_ablation.svg]]

** TODO Pruning

#+header: :width 300 :height 200

#+header: :width 3 :height 2
#+begin_src R :results graphics file :file pruning.tikz
data <- read_csv("data/pruning.csv")
killed_height <- 4500
data %>%
  mutate(
    pattern=killed,
    cycles=if_else(killed, killed_height, cycles),
    params=str_replace_all(params, "_", " ")
  ) %>%
  print(n=10) %>%
  ggplot(aes(
    x=factor(params, levels=unique(params)),
    y=cycles,
    fill=pruning,
    pattern=pattern
  )) +
  geom_col_pattern(
    position="dodge",
    width=0.5,
    color="black",
    pattern_color="black",
    pattern_spacing=0.05,
    pattern_density=0.35,
  ) +
  geom_hline(
    yintercept=killed_height,
    color="red"
  ) +
  scale_fill_manual(
    values=c("#eeeeee", "#fb9a99"),
    labels=c("No Pruning", "Pruning")
  ) +
  scale_pattern_manual(
    values=c("none", "stripe"),
  ) +
  labs(
    x="2d-conv Params",
    y="Cost",
    fill="Pruning"
  ) +
  guides(pattern="none", fill=guide_legend(override.aes = list(pattern="none"))) +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size=7, face="bold"),
    axis.title.y = element_text(size=8, face="bold"),

    axis.text.x = element_text(size=5),
    axis.text.y = element_text(size=7),

    legend.position = "top",
    legend.background = element_blank(),
    legend.text = element_text(size=7, face="bold"),
    legend.title = element_blank(),
    legend.key.size = unit(0.75, "lines"),
    legend.box.spacing = unit(0, "lines"), 
    legend.margin = margin(0, 0, 2, 0),
  )
#+end_src

#+RESULTS:
[[file:pruning.tikz]]

** Ruleset ablation

#+header: :width 11 :height 4

#+header: :width 3 :height 2
#+begin_src R :results graphics file :file ruleset-ablation.tikz
data <- read_csv("data/ruleset_ablation.csv") %>% select(-index)
noeqsat <- read_csv("data/noeqsat.csv") %>%
  mutate(ruleset=0, noeqsat=cycles) %>%
  select(-c(kernel, correct, cycles, ruleset)) %>%
  filter(benchmark == "2d-conv")

data <- left_join(
  data,
  noeqsat,
  by=c("benchmark", "params"),
)

data <- data %>%
  select(benchmark, params, exp, ruleset, cycles, cost, noeqsat) %>%
  mutate(
    name=str_c(str_replace_all(params, "_", "\n")),
  ) %>%
  group_by(params) %>%
  filter(ruleset > 0) %>%
  filter(ruleset != 43200) %>%
  filter(ruleset != 86400) %>%
  print(n=10) %>%
  mutate(
    # calculate speedup against the second item in every group
    across(cycles:cost, ~ .[1] / .)
    ## cycles=noeqsat / cycles
    ## across(cycles:cost, ~ .[3] / .)
  ) %>% print(n=10)

data %>%
  ggplot(aes(
    ## x=names,
    ## y=cycles,
    xmin=as.numeric(factor(name, levels=unique(name))) - 0.35,
    xmax=as.numeric(factor(name, levels=unique(name))) + 0.35,
    ymin=0, ymax=cycles,
    fill=factor(ruleset)
  )) +
  geom_rect(
    position="dodge",
    color="black"
  ) +
  geom_hline(yintercept=1, linetype="solid", color="black") +
  scale_x_continuous(
    label=unique(data$name),
    breaks=1:length(unique(data$name))
  ) +
  scale_fill_brewer(
    palette = "YlOrBr",
  ) +
  labs(fill="Timeout", y="Speedup Cycles", x="2d-conv Params") +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size=7, face="bold"),
    axis.title.y = element_text(size=8, face="bold"),

    axis.text.x = element_text(size=5),
    axis.text.y = element_text(size=7),

    legend.position = "top",
    legend.background = element_blank(),
    legend.text = element_text(size=7),
    legend.title = element_text(size=7, face="bold"),
    legend.key.size = unit(0.75, "lines"),
    legend.box.spacing = unit(0, "lines"), 
    legend.margin = margin(0, 0, 2, 0),
  )
#+end_src

#+RESULTS:
[[file:ruleset-ablation.tikz]]

** Instruction Ablation

#+header: :file instruction.tex

#+header: :results output 

#+begin_src R 
data <- read_csv("data/instruction.csv", show_col_types=F, progress=F) %>%
  filter(benchmark == "qr-decomp") %>%
  mutate(
    muls=if_else(rules == "muls" | rules == "ruleset", "MULS", "No MULS"),
    mulsgn=if_else(rules == "mulsgn" | rules == "ruleset", "MulSgn", "No MulSgn"),
    speedup=round(1229 / cycles, 2)*100,
    show=if_else(speedup >= 100, str_c("+", speedup-100, "%"), str_c("-", 100-speedup, "%"))
  ) %>%
  select(muls, mulsgn, show) %>%
  print(n=10) %>%
  pivot_wider(names_from=c(muls), values_from=show) %>%
  mutate(` `=mulsgn) %>%
  select(` `, `MULS`, `No MULS`)

## print(xtable(
##   data,
##   caption=str_c(
##     "Cycle estimates for QR-Decomp for all",
##     " combinations of including MAC and MULS instructions."
##   )), include.rownames=FALSE)
#+end_src

#+RESULTS:
|           | MULS | No MULS |
|-----------+------+---------|
| MulSgn    |  +2% |     +0% |
| No MulSgn |  +2% |     +0% |

** TODO Greedy Cost Works

The data here is wrong I think. Fix the data

#+begin_src R :results graphics file :file greedy_cost.svg
data <- read.csv("data/greedy_cost_works.csv")

# fix the order of the df in place
data$params <- factor(data$params, levels=rev(unique(data$params)))

data %>%
  filter(benchmark == "2d-conv") %>%
  ggplot(aes(fill=costfn, x=params, y=egraph_cost)) +
  geom_bar(position="dodge", stat="identity", color="black") +
  ## geom_text(
  ##   aes(label=round(egraph_cost)),
  ##   color="black",
  ##   size=3.5,
  ##   position=position_dodge(0.9)) +
  labs(x="Params", y="EGraph Cost", fill="Cost Function") +
  coord_flip() + theme_minimal() +
  theme(
    legend.position = c(0.80, 0.90),
    legend.background = element_rect(fill = "white"),
    text = element_text(size=16, face="bold")
  )
  ## theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1))
#+end_src

#+RESULTS:
[[file:greedy_cost.svg]]

** Backoff scheduler doesn't work

#+begin_src R :results graphics file :file scheduler-backoff.svg
data <- read.csv("~/Research/comp-gen/server/completed/2d-conv_3x3_3x3/20/data.csv")

data %>%
  filter(name == "nodes" | name == "cost" & iteration != "report") %>%
  pivot_wider(
    names_from = name,
    values_from = value
  ) %>%
  mutate(
    cost = as.numeric(cost),
    nodes = as.numeric(nodes),
  ) %>%
  ggplot(aes(
    x=log10(nodes),
    y=cost/max(cost)
  )) +
  geom_path(linewidth=1.5) + geom_point(size=2) +
  ylim(0, 1) +
  theme_minimal() + theme(
    legend.position = c(0.85, 0.9),
    legend.background = element_rect(fill = "white"),
    text = element_text(size=16, face="bold")
  )
#+end_src

#+RESULTS:
[[file:scheduler-backoff.svg]]

#+begin_src R :results graphics file :file scheduler-backoff-cost.svg
data <- read.csv("data/backoff_cost.csv")

data %>%
  filter(benchmark == "2d-conv") %>%
  filter(params == "3x3_2x2") %>%
  ggplot(aes(
    x=iteration,
    y=value)) +
  geom_path() +
  theme_minimal() + theme(
    legend.position = c(0.85, 0.9),
    legend.background = element_rect(fill = "white"),
    text = element_text(size=16, face="bold")
  )
  
  ## filter(name == "nodes" | name == "cost" & iteration != "report") %>%
  ## pivot_wider(
  ##   names_from = name,
  ##   values_from = value
  ## ) %>%
  ## mutate(
  ##   cost = as.numeric(cost),
  ##   nodes = as.numeric(nodes),
  ## ) %>%
  ## ggplot(aes(
  ##   x=log10(nodes),
  ##   y=cost/max(cost)
  ## )) +
  ## geom_path(linewidth=1.5) + geom_point(size=2) +
  ## ylim(0, 1) +
#+end_src

#+RESULTS:
[[file:scheduler-backoff-cost.svg]]

** Misc

#+begin_src R :results graphics file :file iter_cost.svg
data <- read.csv("data/2d-conv-3x3_3x3_iter.csv")

data %>%
  group_by(pruning) %>%
  mutate(cost = cost / max(cost)) %>%
  ggplot(aes(x=index, y=cost, group=pruning, color=pruning)) +
  geom_line() + geom_point() +
  theme_minimal() +
  labs(x="Iteration", y="Cost / max(Cost)", color="Cost Function") +
  theme(
    legend.position = c(0.80, 0.90),
    legend.background = element_rect(fill = "white"),
    text = element_text(size=16, face="bold")
  )
#+end_src

#+RESULTS:
[[file:iter_cost.svg]]

* Overview Example

For exposition purposes, we want to explain /why/ these large ruleset blow up the graph. Ideally we want to find a particular rule that does this.

#+header: :dir (ec2/tramp "overview" "comp-gen")
#+begin_src async-shell :results none :name overview
export compgen_bin="cargo run --release --manifest-path=$(realpath dios-lang/Cargo.toml)"
export dios_bin=$(realpath ../custom-diospyros/dios)
export dios_example_bin=$(realpath ../custom-diospyros/dios-example-gen)

cd server/overview/
time ./run.sh
#+end_src

* Copy Images to paper

#+begin_src async-shell :results none
DEST=$(realpath ~/Research/comp-gen-paper/figures)
# for f in $(echo compile-times.svg); do
#     echo "Exporting $f to $DEST/${f%.*}.pdf"
#     inkscape $f --export-filename="$DEST/${f%.*}.pdf"
# done

function g() {
    while read; do
        for f in $(echo *.tikz *.tex); do
            echo "Exporting $f to $DEST/${f%.*}.tex"
            cp $f "$DEST/${f%.*}.tex"
        done
        make -C $(realpath ~/Research/comp-gen-paper) -B
    done
}

fswatch -o . | g
#+end_src

* Debugging

#+header: :dir (sgt/dir "server" "test")
#+begin_src async-shell :name test :results none
ROOT="/home/samthomas/Research/xtensa/RI-2021.8-linux/XtensaTools/bin"

$ROOT/xt-clang++ -std=c++11 -mlongcalls \
                 -O3 -LNO:simd -LNO:simd_v -fvectorize -mtext-section-literals \
                 -DXCHAL_HAVE_FUSIONG_SP_VFPU=1 \
                 kernel.c -S

$ROOT/xt-clang++ -std=c++11 -mlongcalls \
                 -O3 -LNO:simd -fvectorize -mtext-section-literals \
                 -DXCHAL_HAVE_FUSIONG_SP_VFPU=1 \
                 kernel.c harness.c -o run.o

$ROOT/xt-run --client_commands='trace --level=0 trace.out' run.o
#+end_src

#+header: :dir (sgt/dir "server")
#+begin_src async-shell :name test
EXP="diospyros-results-log/2d-conv/3x3_3x3_4r"
make -C ~/Research/diospyros dios
~/Research/diospyros/dios -w 4 --egg --suppress-git -o $EXP/kernel.c $EXP
cp harnesses/utils.h $EXP
cp harnesses/2d-conv.c $EXP/harness.c
./estimate.py single --force --results "." --name 2d-conv --params 3x3_3x3 $EXP
#+end_src

#+begin_src async-shell :name test :dir (sgt/dir "server") :results none
DIR=completed/mat-mul_8x8_8x8/18
# ~/Research/diospyros/dios -w 4 --egg --suppress-git \
#                           -o $DIR/results/kernel.c \
#                           $DIR/results
./estimate.py log $DIR
#+end_src

Debug a job by running it locally

#+begin_src async-shell :dir (sgt/dir) :results none :name debug :ansi t
export compgen_bin="cargo run --release --manifest-path=$(realpath dios-lang/Cargo.toml)"
export dios_bin=$(realpath ../diospyros/dios)
export dios_example_bin=$(realpath ../diospyros/dios-example-gen)

cd server/jobs/Apr16-2341-qr-decomp_3-0
./run.sh
#+end_src

Debugging why our synthesizer doesn't generate rules like =(sqrt 1) <-> 1=

#+begin_src async-shell :dir (sgt/dir) :results none :ansi t
RUST_LOG=info,egg=info,z3=off cargo run --release --manifest-path=dios-lang/Cargo.toml -- \
      synth server/test/out.json --config server/synthesis/debug.json
#+end_src

* Potential Names

Chourmas

Equality saturation, synthesis, closure, DSP, vector

Ekastos (each, every, in greek) ἕκᾰστος
